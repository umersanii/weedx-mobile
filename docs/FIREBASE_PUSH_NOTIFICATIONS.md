# Firebase Push Notifications Setup Guide

## Overview

The WeedX system now supports Firebase Cloud Messaging (FCM) push notifications for real-time alerts. When the robot publishes alerts to the `weedx/alert` MQTT topic, the backend automatically sends push notifications to the user's Android device(s).

## Architecture

```
Robot → MQTT (weedx/alert) → PHP Subscriber → MySQL + Firebase FCM → Android App
```

## Prerequisites

1. Firebase project with FCM enabled
2. Firebase service account credentials JSON file
3. Android app with Firebase SDK integrated
4. PHP backend with Firebase Admin SDK

## Backend Setup

### 1. Install Firebase Admin SDK

Add to `composer.json`:
```json
{
    "require": {
        "kreait/firebase-php": "^7.0"
    }
}
```

Then run:
```bash
cd /home/umersani/weedx-mobile/xampp/htdocs/backend
php composer.phar install
```

### 2. Download Firebase Service Account Credentials

1. Go to Firebase Console → Project Settings → Service Accounts
2. Click "Generate New Private Key"
3. Save the JSON file as `firebase-service-account.json`
4. Place it in `/home/umersani/weedx-mobile/xampp/htdocs/backend/config/`

**Security**: Never commit this file to Git! Add to `.gitignore`:
```
config/firebase-service-account.json
```

### 3. Deploy Backend

```bash
bash /home/umersani/weedx-mobile/scripts/deploy-backend.sh
```

### 4. Create FCM Tokens Table

Run this SQL migration:
```bash
mysql -u root -p weedx < /home/umersani/weedx-mobile/xampp/htdocs/backend/database/add_fcm_tokens_table.sql
```

### 5. Restart MQTT Subscriber

```bash
sudo systemctl restart weedx-mqtt
sudo journalctl -u weedx-mqtt -f
```

You should see: `Firebase notification service initialized`

## Android App Setup

### 1. Add Firebase to Your Android Project

1. Download `google-services.json` from Firebase Console
2. Place it in `app/` directory
3. Already configured in `app/build.gradle.kts`

### 2. Request Notification Permission (Android 13+)

The app already requests `POST_NOTIFICATIONS` permission in `AndroidManifest.xml`. Users will be prompted when first launching the app.

### 3. Build and Install

```bash
cd /home/umersani/weedx-mobile
./gradlew assembleDebug
# Install APK on device
```

## Testing Push Notifications

### Test via MQTT

Publish an alert message:

```bash
mosquitto_pub -h localhost -p 1883 -t "weedx/alert" -m '{
    "user_id": 1,
    "type": "battery",
    "severity": "warning",
    "message": "Battery level at 20%. Please charge soon."
}'
```

You should see:
1. Alert saved to database
2. Push notification sent to user's device(s)
3. Notification appears on Android device

### Test Different Alert Types

**Critical Alert** (high priority with sound):
```bash
mosquitto_pub -h localhost -p 1883 -t "weedx/alert" -m '{
    "user_id": 1,
    "type": "fault",
    "severity": "critical",
    "message": "Robot malfunction detected! Stopping operations."
}'
```

**Info Alert** (low priority):
```bash
mosquitto_pub -h localhost -p 1883 -t "weedx/alert" -m '{
    "user_id": 1,
    "type": "detection",
    "severity": "info",
    "message": "50 weeds detected in the last hour."
}'
```

**Maintenance Alert**:
```bash
mosquitto_pub -h localhost -p 1883 -t "weedx/alert" -m '{
    "user_id": 1,
    "type": "maintenance",
    "severity": "warning",
    "message": "Scheduled maintenance due in 2 days."
}'
```

## Alert Types and Icons

| Type | Severity | Icon | Priority |
|------|----------|------|----------|
| `battery` | warning/critical | Battery | Default/High |
| `fault` | critical | Error | High |
| `maintenance` | warning | Settings | Default |
| `detection` | info | Eco/Leaf | Low |

## API Endpoints

### Register FCM Token

**Endpoint**: `POST /api/profile/fcm-token`

**Headers**:
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

**Request Body**:
```json
{
    "token": "FCM_DEVICE_TOKEN_HERE",
    "device_info": "Samsung Galaxy S21 (Android 13)"
}
```

**Response**:
```json
{
    "success": true,
    "message": "FCM token registered successfully"
}
```

### Deactivate FCM Token (Logout)

**Endpoint**: `DELETE /api/profile/fcm-token`

**Headers**:
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

**Request Body**:
```json
{
    "token": "FCM_DEVICE_TOKEN_HERE"
}
```

## How It Works

### 1. Token Registration Flow

```
Android App Launches
    ↓
FCM Token Generated by Firebase SDK
    ↓
DashboardActivity.registerFcmToken()
    ↓
POST /api/profile/fcm-token
    ↓
Token Saved to MySQL (fcm_tokens table)
```

### 2. Notification Flow

```
Robot Publishes Alert to MQTT
    ↓
PHP Subscriber Receives Alert
    ↓
Alert Saved to MySQL (alerts table)
    ↓
FirebaseNotificationService.sendAlert()
    ↓
Fetch User's FCM Tokens from Database
    ↓
Send Notification via Firebase Admin SDK
    ↓
Notification Delivered to User's Device(s)
    ↓
WeedXFirebaseMessagingService.onMessageReceived()
    ↓
Display Android Notification
```

### 3. Token Lifecycle

- **Registration**: When user logs in or app launches
- **Storage**: Saved in `fcm_tokens` table with `user_id` link
- **Multi-device**: One user can have multiple tokens (phone, tablet, etc.)
- **Deactivation**: When user logs out
- **Cleanup**: Invalid tokens automatically removed by service

## Multi-User Support

Each FCM token is associated with a specific `user_id`. When an alert is published with a `user_id`, the notification is sent only to that user's registered devices.

```json
{
    "user_id": 2,
    "type": "battery",
    "severity": "warning",
    "message": "Battery at 15%"
}
```

## Monitoring

### Check FCM Tokens in Database

```sql
SELECT u.username, f.token, f.device_info, f.active, f.updated_at
FROM fcm_tokens f
JOIN users u ON f.user_id = u.id
WHERE f.active = 1;
```

### Monitor MQTT Subscriber Logs

```bash
sudo journalctl -u weedx-mqtt -f | grep -i "notification\|firebase\|fcm"
```

You should see:
- `Firebase notification service initialized`
- `Push notification sent to user 1`
- `Notification sent successfully to token: ...`

### Test Backend API

```bash
# Get auth token first
TOKEN="your_jwt_token_here"

# Register FCM token
curl -X POST http://raspberrypi.mullet-bull.ts.net/weedx-backend/api/profile/fcm-token \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "token": "test_fcm_token_12345",
    "device_info": "Test Device"
  }'
```

## Troubleshooting

### No Notifications Received

1. **Check Firebase Initialization**:
   ```bash
   sudo journalctl -u weedx-mqtt -f
   # Should see: "Firebase notification service initialized"
   ```

2. **Verify Service Account File**:
   ```bash
   ls -la /var/www/html/weedx-backend/config/firebase-service-account.json
   ```

3. **Check FCM Token Registration**:
   ```sql
   SELECT * FROM fcm_tokens WHERE user_id = 1 AND active = 1;
   ```

4. **Test Firebase Manually** (PHP script):
   ```php
   require_once 'vendor/autoload.php';
   $factory = (new Kreait\Firebase\Factory)
       ->withServiceAccount('config/firebase-service-account.json');
   $messaging = $factory->createMessaging();
   echo "Firebase initialized successfully!\n";
   ```

5. **Check Android Logs**:
   ```bash
   adb logcat | grep -i "fcm\|firebase\|notification"
   ```

### Notifications Not Showing on Android

1. Check app has notification permission
2. Verify notification channel is created
3. Check Do Not Disturb settings
4. Ensure app is not battery-optimized

### Invalid FCM Token Errors

Invalid tokens are automatically removed from the database. This is normal when:
- User uninstalls the app
- User clears app data
- FCM token expires/rotates

## Security Considerations

### Production Deployment

1. **Secure Service Account File**:
   ```bash
   sudo chown www-data:www-data /var/www/html/weedx-backend/config/firebase-service-account.json
   sudo chmod 600 /var/www/html/weedx-backend/config/firebase-service-account.json
   ```

2. **Use Environment Variables** (alternative):
   ```php
   $serviceAccountPath = getenv('FIREBASE_SERVICE_ACCOUNT_PATH');
   ```

3. **Token Authentication**: All FCM endpoints require JWT authentication

4. **Rate Limiting**: Consider adding rate limits to notification endpoints

## Files Reference

### Backend Files

| File | Purpose |
|------|---------|
| `utils/firebase_notification.php` | Firebase notification service class |
| `mqtt/subscriber.php` | MQTT subscriber with FCM integration |
| `api/profile/fcm-token.php` | FCM token registration endpoint |
| `config/firebase-service-account.json` | Firebase credentials (not in repo) |
| `database/add_fcm_tokens_table.sql` | Database migration |

### Android Files

| File | Purpose |
|------|---------|
| `services/WeedXFirebaseMessagingService.kt` | FCM service handler |
| `data/api/FcmTokenApiService.kt` | Retrofit API interface |
| `data/repositories/FcmTokenRepository.kt` | FCM token repository |
| `data/models/request/FcmTokenRequest.kt` | API request model |
| `DashboardActivity.kt` | Token registration on app launch |

## Notification Customization

### Custom Notification Icons

Icons are in `app/src/main/res/drawable/`:
- `ic_battery_alert.xml` - Battery alerts
- `ic_error.xml` - Fault/error alerts
- `ic_settings.xml` - Maintenance alerts
- `ic_eco.xml` - Weed detection alerts (use existing)
- `ic_notifications.xml` - Default notifications

### Custom Notification Sounds

Edit `WeedXFirebaseMessagingService.kt`:
```kotlin
if (priority == NotificationCompat.PRIORITY_HIGH) {
    notificationBuilder.setSound(Uri.parse("android.resource://${packageName}/raw/alert_sound"))
}
```

### Custom Actions

Add notification actions:
```kotlin
val actionIntent = PendingIntent.getActivity(...)
notificationBuilder.addAction(R.drawable.ic_view, "View Details", actionIntent)
```

## Future Enhancements

- [ ] Notification preferences (enable/disable by type)
- [ ] Custom notification sounds per alert type
- [ ] In-app notification history
- [ ] Push notification analytics
- [ ] Topic-based notifications (subscribe to specific robot/field)
- [ ] Rich notifications with images
- [ ] Notification actions (e.g., "Acknowledge", "View Robot")

## License

Part of the WeedX precision farming system.
